# Миграции БД в Go

<Meta>
reading_time: 10
</Meta>

<Overview>
1. Миграции — обязательная часть backend‑разработки (схема БД живёт вместе с кодом)
2. Подход: **версионированные SQL файлы** + инструмент применения (goose/migrate)
3. Миграции должны быть **повторяемыми** и работать в CI
4. В проде миграции — это риск: блокировки, время выполнения, совместимость
5. Лучшие практики: маленькие миграции, обратимость где возможно, тест на “up” в CI
</Overview>

<Theory>
### Почему нельзя “ручками”

Если схему править вручную:
- у разных окружений разная схема
- нельзя быстро поднять dev окружение
- невозможно повторить историю изменений

Миграции дают:
- воспроизводимость
- код‑ревью изменений БД
- возможность отката (иногда)

### Где запускать миграции

Есть два типовых подхода:

1) **Отдельный шаг** (рекомендуется): миграции запускаются отдельной командой в CI/CD  
2) **При старте приложения**: удобно, но рискованно (конкурентный запуск, блокировки, непредсказуемое время)

Для capstone проектов можно начать с “при старте”, но лучше дойти до отдельного шага.
</Theory>

<Syntax>
### Структура миграций (пример)

```
migrations/
  0001_init.up.sql
  0001_init.down.sql
  0002_add_users_email_index.up.sql
  0002_add_users_email_index.down.sql
```

### Пример: migrate (golang-migrate)

```bash
# создать миграцию
migrate create -ext sql -dir migrations -seq init

# применить
migrate -path migrations -database "$DATABASE_URL" up

# откатить одну
migrate -path migrations -database "$DATABASE_URL" down 1
```

### Пример: goose

```bash
goose -dir migrations postgres "$DATABASE_URL" up
goose -dir migrations postgres "$DATABASE_URL" down
```
</Syntax>

<Examples>
### Пример: init миграция (Postgres)

`0001_init.up.sql`

```sql
CREATE TABLE IF NOT EXISTS users (
  id BIGSERIAL PRIMARY KEY,
  email TEXT NOT NULL UNIQUE,
  password_hash TEXT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS users_created_at_idx ON users(created_at);
```

`0001_init.down.sql`

```sql
DROP TABLE IF EXISTS users;
```

### Пример: docker-compose для dev с Postgres

```yaml
services:
  db:
    image: postgres:16
    environment:
      POSTGRES_USER: app
      POSTGRES_PASSWORD: app
      POSTGRES_DB: app
    ports:
      - "5432:5432"
```
</Examples>

<Pitfalls>
1. **Длинные ALTER на больших таблицах**: может залочить таблицу на проде
2. **Невозможный down**: некоторые изменения необратимы — фиксируйте это в процессе
3. **Миграции + код несовместимы**: планируйте backward‑compat (двухфазные деплои)
4. **Конкурентный запуск миграций**: несколько инстансов пытаются мигрировать одновременно
5. **Нет теста миграций**: миграции должны проходить в CI на чистой БД
</Pitfalls>

<Links>
- `https://github.com/golang-migrate/migrate`
- `https://github.com/pressly/goose`
- `https://www.postgresql.org/docs/current/sql-altertable.html`
</Links>

<Task id="lab" mode="manual" points="60">
<Title>Лаба: Миграции для capstone (локально + CI)</Title>
<Prompt>
Добавьте полноценные миграции БД в capstone‑репозиторий и включите их проверку в CI.

### Требования

1) **Инструмент миграций**
- Выберите `goose` или `migrate`\n- Добавьте папку `migrations/`\n- Команды для разработчика:\n  - `migrate up`\n  - `migrate down`\n  - `migrate status` (опционально)\n- Опишите всё в README/Makefile

2) **Схема**
- Перенесите создание таблиц из “AutoMigrate”/ручного SQL в миграции\n- Миграции должны быть применимы на чистую БД

3) **Docker Compose**
- Добавьте сервис/джобу для применения миграций (опционально), либо явную команду `make migrate-up` для compose окружения

4) **CI**
- В GitHub Actions:\n  - поднять Postgres service container\n  - применить миграции на чистую БД\n  - запустить интеграционные тесты\n
</Prompt>
<Criteria>
- Новый разработчик может поднять проект одной инструкцией (compose + migrate + run)\n- CI падает, если миграции не применяются\n- Миграции не зависят от ручных действий/порядка\n</Criteria>
<Hints>
- Подумайте о конкурентном запуске миграций (локально ок, в проде обычно выделяют отдельный job).\n- Делайте миграции обратимыми, где это разумно.\n</Hints>
</Task>

